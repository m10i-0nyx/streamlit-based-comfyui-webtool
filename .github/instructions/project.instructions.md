---
applyTo: "**"
---

# Streamlit Based ComfyUI Web tool 実装ガイドライン

## 概要

- 別で構築されたComfyUI API + WebSocketサーバーと連携し、ComfyUIのノード操作を行うためのフロントエンドアプリケーションを提供すること
  - フロントエンドアプリケーションにはStreamlitを使用すること
  - バックエンドのComfyUIとの通信は全てStreamlit側で構築されたクライアントを用いて行うこと(ユーザにはComfyUIを見せない *セキュリティ担保のため*)
- ComfyUIのノード操作をより直感的かつ効率的に行うためのユーザーインターフェースを提供すること
- ノード設計はあらかじめ提供されたJSONファイルを用いて行い、ユーザは下記のみ変更可能とする
  - プロンプト/ネガティブプロンプトの入力
  - ランダムシード値(seed値)の指定もしくはランダム生成
- 下記については環境変数で定義される(.env ファイル)
  - ComfyUI API + WebSocketサーバーのエンドポイント(URL)
  - 利用するノード設計(JSONファイル)
  - 生成される画像サイズの選択肢(幅、高さ)

## アーキテクチャ
- Streamlitアプリケーションは、ComfyUI API + WebSocketサーバーと通信するためのクライアントモジュールを含む
- ユーザーインターフェースはStreamlitのウィジェットを使用して構築される
- ノード設計はJSONファイルとして外部に保存され、アプリケーション起動時に読み込まれる
- 画像生成リクエストは、ユーザーが入力したプロンプト、ネガティブプロンプト、シード値を含むノード設計を
  ComfyUI API + WebSocketサーバーに送信することで行われる
- ユーザはセッション単位で管理され、同時に複数のユーザーが利用可能とする
  - 1ユーザ当たりのComfyUIリクエスト制限を可能とする

### セッション・状態管理
- **ジョブキュー**: session_stateのみで管理（LocalStorageには保存しない）
  - ページリロード時は常に空で初期化
  - 一時的な処理キューとして機能
- **履歴データ**: LocalStorageに永続化
  - 各エントリにcreated_at（UNIXタイムスタンプ）を自動付与
  - TTL処理により古いエントリを自動削除（デフォルト600秒、環境変数で設定可能）
  - created_atがないエントリは自動的に除外される
- **画像データ**: session_stateのimages_storeで管理（メモリベース）
  - ULIDをキーとしてバイトデータを保存
  - セッション終了時に自動的にクリーンアップ

### パフォーマンス最適化
- **Fragment API**: 履歴表示部分のみを10秒ごとに自動更新
  - ページ全体のリロードを回避
  - フォーム入力の中断を防止
- **LocalStorageクリーンアップ**:
  - TTL超過エントリの自動削除でストレージ使用量を制限
  - 不正なデータ（created_atなし）の自動除外
- **リソース管理**:
  - 実行中ジョブのカウント管理（ユーザー単位・グローバル）
  - 同時実行数の制限による負荷分散

### セキュリティ対策
- **入力値検証**:
  - 画像サイズ（width/height）は環境変数で定義された許可リストに対して検証
  - ユーザーがブラウザ開発者ツールで改ざんした値は拒否
  - シード値は-1から2^31-1の範囲に制限
- **エンドポイント保護**:
  - ComfyUI APIエンドポイントをユーザーに露出しない
  - エラーメッセージから機密情報（URL等）を自動除外
- **データサニタイズ**:
  - すべてのユーザー入力をWorkflowテンプレートに安全に埋め込み

## 基本
- 日本語で回答してください
- 必要に応じて、ユーザに質問を行い、要求を明確にすること
- 作業後、作業内容とユーザが次に取れる行動を説明すること
- 作業項目が多い場合は、段階に区切り、git commit を行いながら進めること
  - semantic commit を使用する
  - コミットメッセージは 英語で記述すること
- 簡潔で分かりやすい説明を心がけてください
- ベストプラクティスの具体例を提示してください
- 学習リソースの提案を積極的に行ってください
- 常に日本語で分かりやすい言葉を選び、丁寧な表現を心がけてください
- スケーラビリティとパフォーマンスを重点的にチェックしてください

## コードレビュー専用指示
### レビューの基本方針
以下のプレフィックスを使用してレビューコメントを分類してください：
- `[must]` - 必須修正項目（セキュリティ、バグ、重大な設計問題）
- `[recommend]` - 推奨修正項目（パフォーマンス、可読性の大幅改善）
- `[nits]` - 軽微な指摘（コードスタイル、タイポ等）

### 重点チェック項目
1. **セキュリティ**:
   - SQLインジェクション、XSS、認証・認可の不備
   - ComfyUIのエンドポイント保護とエラーメッセージからの機密情報除外
   - 入力値のバリデーション（画像サイズの許可リスト、シード値の範囲制限）
2. **パフォーマンス**:
   - N+1問題、不要なループ、メモリリーク
   - Fragment APIの適切な使用（部分更新の活用）
   - LocalStorageのTTL処理と不要データのクリーンアップ
   - 同時実行数制御による負荷分散
3. **可読性**: 変数名、関数名、コメントの適切性
4. **保守性**:
   - DRY原則、SOLID原則の遵守
   - 環境変数による設定の外部化（TTL、リクエスト上限等）
5. **テスト**: テストケースの網羅性、エッジケースの考慮
6. **言語固有のベストプラクティス**: 各言語の推奨パターンに準拠しているか、非推奨・廃止予定のAPIや構文を使用していないかチェック
7. **状態管理**:
   - session_stateとLocalStorageの適切な使い分け
   - タイムスタンプ（created_at）の一貫した付与
   - データの永続化戦略（一時的 vs 永続的）
