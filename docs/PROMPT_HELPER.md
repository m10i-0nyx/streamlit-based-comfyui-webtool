# プロンプト入力支援機能

## 概要

Danbooruタグ辞書を使用したプロンプト・ネガティブプロンプトの入力支援機能を実装しました。

## 機能詳細

### 1. タグ辞書の自動取得

- Hugging Faceの[danbooru-tag-csv](https://huggingface.co/datasets/newtextdoc1111/danbooru-tag-csv)データセットから自動的にタグデータを取得
- ダウンロードされたデータはローカルにキャッシュされ、次回以降は高速に読み込み
- ネットワークエラーなどで取得できない場合は、基本的なタグリストをフォールバックとして使用

### 2. タグ検索機能

**検索方法:**
- 英語のタグ名で検索（例: `1girl`, `smile`, `long_hair`）
- 日本語でも検索可能（例: `笑顔`, `ロングヘア`, `女の子`）
- 検索クエリが空の場合は、人気タグ（使用数順）を表示
- **AND検索**: 複数キーワードをスペースまたはカンマで区切ると、全てのキーワードに一致するタグを検索
  - 例: `long hair` → 「long」と「hair」の両方を含むタグを検索
  - 例: `青, 髪` → 「青」と「髪」の両方に一致するタグを検索
- **NOT検索（除外）**: `-`を付けると該当するタグを除外
  - 例: `smile -open_mouth` → 「smile」を含み「open_mouth」を含まないタグ
  - 例: `髪 -短` → 「髪」に関連し「短」を含まないタグ
  - 例: `-nsfw` → 「nsfw」を含まないタグ（人気タグから除外）

**検索結果の表示:**
- タグはカテゴリ別に色分けされたアイコンで表示
  - 🔵 一般タグ
  - 🟡 アーティスト
  - 🟢 著作権
  - 🟣 キャラクター
  - 🔴 メタタグ
- 各タグボタンにはツールチップで使用数が表示
- グリッドレイアウトで見やすく配置

### 3. タグ選択機能

- 検索結果のタグボタンをクリックすると、選択中のタグリストに追加
- 選択したタグは自動的にプロンプト入力欄に反映
- 「クリア」ボタンで選択したタグを一括削除

### 4. ネガティブプロンプトプリセット

以下のプリセットから選択可能:
- **なし**: 空のネガティブプロンプト
- **基本**: 基本的な品質改善用ネガティブプロンプト
- **高品質重視**: より詳細な品質改善用ネガティブプロンプト
- **NSFW回避**: NSFW（成人向け）コンテンツを回避するためのプロンプト
- **カスタム**: タグ支援機能を使用してカスタムで入力

## 使い方

### 基本的な使い方

1. **プロンプト入力欄**の下にある「🏷️ タグから選択」エキスパンダーを開く
2. 検索ボックスに英語または日本語でタグを入力
   - 単一キーワード: 通常検索
   - 複数キーワード（スペース/カンマ区切り）: AND検索
   - `-`で始まるキーワード: 除外検索
3. 表示されたタグボタンをクリックして選択
4. 選択したタグが自動的にプロンプトに追加される

**検索例:**
- `smile` → 「smile」を含むタグを検索
- `long hair` → 「long」と「hair」の両方を含むタグ
- `blue eyes -red` → 「blue」と「eyes」を含み「red」を含まないタグ
- `-nsfw -nude` → 「nsfw」と「nude」を両方含まないタグ（人気タグから除外）

### ネガティブプロンプトの設定

1. **ネガティブプロンプト プリセット**ドロップダウンから目的に応じたプリセットを選択
2. 「カスタム」を選択した場合は、タグ支援機能を使用して個別に入力可能

### 人気タグの活用

検索クエリを空にすると、自動的に人気タグ（使用頻度が高いタグ）が表示されます。
これにより、よく使われるタグを素早く選択できます。

## 技術詳細

### モジュール構成

#### `app/tag_dictionary.py`
Danbooruタグ辞書を管理するモジュール

**主要クラス:**
- `TagDictionary`: タグデータの読み込み、検索、管理を行う
  - `load()`: Hugging Faceまたはローカルファイルからタグデータを読み込み
  - `search(query, limit)`: クエリに基づいてタグを検索
  - `get_popular_tags(limit)`: 人気タグを取得
  - `get_tag(tag_name)`: 特定のタグ情報を取得

**キャッシング:**
- `@st.cache_resource`デコレータにより、タグ辞書はアプリケーション全体で共有され、一度のみ読み込まれる

#### `app/prompt_helper.py`
プロンプト入力支援UIコンポーネント

**主要関数:**
- `render_tag_search_widget(key_prefix)`: タグ検索ウィジェットを表示
- `render_prompt_input_with_tags(...)`: タグ支援付きプロンプト入力欄
- `render_negative_prompt_presets(key)`: ネガティブプロンプトプリセット選択

### データ構造

タグデータはCSV形式で以下の列を持ちます:
1. **タグ名**: Danbooruの正式タグ名（英語）
2. **カテゴリ**: タグのカテゴリID（0=一般, 1=アーティスト, 3=著作権, 4=キャラクター, 5=メタ）
3. **使用数**: このタグが使用された回数
4. **エイリアス**: 日本語、中国語、韓国語などの翻訳や別名（カンマ区切り）

### 依存パッケージ

新たに追加された依存パッケージ:
- `pandas>=2.0.0`: データフレーム操作
- `datasets>=2.14.0`: Hugging Faceデータセットの読み込み

## インストール

```bash
# 依存パッケージのインストール
pip install -r requirements.txt
```

初回起動時、タグ辞書データが自動的にダウンロードされます（約1-2分）。
ダウンロードされたデータは `~/.cache/streamlit-comfyui/` にキャッシュされます。

## トラブルシューティング

### タグデータの読み込みに失敗する

**症状:** "Hugging Faceからのタグデータ読み込みに失敗" というエラーメッセージが表示される

**対処法:**
1. インターネット接続を確認
2. Hugging Faceが利用可能か確認（https://huggingface.co/）
3. キャッシュをクリアして再試行: `rm -rf ~/.cache/streamlit-comfyui/`
4. フォールバックモードとして基本的なタグリストが自動的に使用される

### タグ検索が遅い

**症状:** タグ検索の応答が遅い

**対処法:**
- タグ辞書は初回のみ読み込まれ、その後はキャッシュされます
- アプリケーションの再起動により改善する可能性があります

### 日本語検索がうまくいかない

**症状:** 日本語で検索してもタグが見つからない

**原因:** データセット内の翻訳データが不完全な場合があります

**対処法:**
- 英語のタグ名で検索してください
- よく使うタグは人気タグから選択できます

## 今後の拡張案

- [ ] お気に入りタグ機能
- [ ] タグの履歴機能（最近使用したタグ）
- [ ] タグの組み合わせプリセット機能
- [ ] ローカルCSVファイルからのタグ辞書読み込み対応
- [ ] タグのカテゴリフィルタリング機能
- [x] より高度な検索機能（AND検索） ✅ 実装済み
